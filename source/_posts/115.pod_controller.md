---
title: K8S (二) --- POD 控制器
date: 2025-09-15 15:37:00
categories: 
- [K8S]
tags: 
- K8S
- Deployment
- Daemonset
- StatefulSet
- Replicas
- Job
- CronJob
---


# 一、 POD 控制器概念

> Pod 控制器是 Kubernetes 编排的核心，帮助开发者从手动运维转向声明式管理，使应用更具弹性和可扩展性

> 在 Kubernetes（K8S）中，Pod 控制器`Pod Controller`是一种核心组件，用于自动化管理和维护 Pod 的生命周期。
Pod 是 K8S 的最小部署单元，通常包含一个或多个容器，但直接管理单个 Pod 效率低下且不灵活。
Pod 控制器通过声明式 API工作：用户定义期望状态`desired state`, 控制器不断监控实际状态`current state`, 并通过协调循环 `reconciliation loop`自动调整系统，使其趋向期望状态。这种设计类似于温控器：设置目标温度，控制器反复检查并调节实际温度。

> Pod 控制器确保 Pod 的创建、更新、缩放和删除过程可靠，尤其在节点故障或网络问题时，能实现自愈和一致性。它们运行在控制平面（如 kube-controller-manager），并与 API 服务器交互。


# 二、 POD 控制器分类


|种类|描述|
|---|---|
|`Deployment`|用于无状态应用的管理，支持 Pod 副本的创建、缩放、滚动更新和回滚。常用于 Web 服务等可互换的 Pod|
|`ReplicaSet`|确保指定数量的 Pod 副本运行，常作为 Deployment 的底层实现，不直接使用|
|`StatefulSet`|用于有状态应用，确保 Pod 的唯一身份、稳定网络标识和有序启动/删除。适合数据库如 MySQL|
|`DaemonSet`|在每个（或指定）节点上运行一个 Pod 副本，常用于系统守护进程，如日志收集器或网络代理|
|`Job`|运行一次性任务，直到完成。Pod 完成后停止，支持并行执行|
|`CronJob`|基于 cron 调度定期运行 Job，适合定时任务如备份或清理|


## 2.1 ReolicaSet

### 主要功能:

  - **维持 POD 副本数量:** 在 `spec.replicas` 中指定需要运行的 Pod 数量
  - **POD 选择器:** 通过 `spec.selector` 定义哪些 Pod 属于该 ReplicaSet
  - **模板化 POD:** 在 `spec.template` 中定义 Pod 的配置，例如容器镜像、端口等


### 简单 ReplicaSet 案例

以下是一个简单的 ReplicaSet 配置文件，创建一个运行 3 个 Nginx Pod 的 ReplicaSet

  ``` yaml
  apiVersion: apps/v1
  kind: ReplicaSet
  metadata:
    name: nginx-replicaset
    namespace: default
  spec:
    replicas: 3
    selector:
      matchLabels:
        app: nginx
    template:
      metadata:
        labels:
          app: nginx
      spec:
        containers:
        - name: nginx
          image: nginx:latest
          ports:
          - containerPort: 80
  ```

创建成功之后, 我们可以尝试手动删除一个pod, 再次观察pod, 会发现就有一个新的pod被创建, 这个就是 ReplicaSet 的主要功能, 位置pod的数量在我们的期望值中.

  ![图](/images/115.pod_controller.md.01.png)

另外一个pod如果符合了rs的标签选择器, 会随机干掉此标签的一个pod

查看当前pod的标签
 `kubectl get pods -o wide --show-labels`
  ![图](/images/115.pod_controller.md.02.png)


## 2.1 Deployment

  - **用途**: 管理无状态应用副本、滚动升级、回滚、扩缩容（与 ReplicaSet 交互）
  - **核心机制**：`Deployment` -> `管理 ReplicaSet（RS`） -> `RS 管理 Pod` , Deployment 控制器根据 `spec.strategy` 做滚动升级或重建
  - **重要字段**：`spec.replicas`、`spec.selector`（必须与 template labels 匹配并且不可随意更改）
  - **两种`Strategy`**: 
    `RollingUpdate`（滚动更新，默认）
      - 特点：逐步替换旧 Pod 为新 Pod，保证服务的持续可用。
      - 相关参数：
        - `maxUnavailable`：在更新过程中，允许最多有多少个 Pod 不可用, 默认 25%
        - `maxSurge`：在更新过程中，允许比期望副本数额外多启动多少个 Pod, 默认 25% 

    `Recreate`（重建）
      - 特点: 先杀掉所有旧 Pod，再启动新 Pod
      - 适应场景:
        - 应用不需要多个版本并行 (比如数据库, 对状态敏感的应用)
        - 不在意短暂的服务中断

----------------------------------------------------------------------------------------

- `apiVersion: app/v1` 版本
- `kind: Deployment` 类型
- `metadata` 元数据
- `spec` 期望状态

  -  --------------replicaset 也有的选项---------------
  - `minReadySeconds:` 应为新创建的pod准备好的最小秒数
  - `replicas：` 副本数； 默认为1
  - `selector：` 标签选择器
  - `template：` 模板（必须的）
    - `metadata：` 模板中的元数据
    - `spec：` 模板中的期望状态

  - **--------------deployment 独有的选项---------------**
  - `strategy：` 更新策略；用于将现有pod替换为新pod的部署策略
    - `Recreate：` 重新创建
    - `RollingUpdate：` 滚动更新
      - `maxSurge：` 可以在所需数量的pod之上安排的最大pod数；例如：5、10%
      - `maxUnavailable：` 更新期间可用的最大pod数
  - `revisionHistoryLimit：` 要保留以允许回滚的旧ReplicaSet的数量，默认10
  - `paused：` 表示部署已暂停，部署控制器不处理部署
  - `progressDeadlineSeconds：` 在执行此操作之前部署的最长时间被认为是失败的
- `status`  当前状态

------------------------------------------------------------------------------------



  - 示例: 下面配置创建一个名为`nginx-deploy` 的 `Deployment`，它会确保始终有 3 个基于 `nginx:1.25` 镜像的 Nginx Pod 在运行，并使用滚动更新策略来平滑地更新这些 Pod，同时保证服务不中断。
     ``` yaml
     apiVersion: apps/v1
     kind: Deployment
     metadata:
       name: nginx-deploy
     spec:
       replicas: 3
       selector:
         matchLabels:
           app: nginx
       strategy:
         type: RollingUpdate
         rollingUpdate:
           maxSurge: 1
           maxUnavailable: 0
       template:
         metadata:
           labels:
             app: nginx
         spec:
           containers:
           - name: nginx
             image: nginx:1.25
             ports:
             - containerPort: 80
     ```

- 更新/回滚命令：
  `kubectl set image deployment/nginx-deploy nginx=nginx:1.26`
  `kubectl rollout status deployment/nginx-deploy`
  `kubectl rollout undo deployment/nginx-deploy`