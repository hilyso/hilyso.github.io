---
title: OCI, CRI ç­‰æ¦‚å¿µè§£é‡Š
date: 2024-07-07 16:00:00
categories: 
- [K8S]
tags: 
- k8s
- cri
- cri
- oci
- cri-docker
- cri-containerd
---


# æ ¸å¿ƒæ¦‚å¿µä»¥åŠåè¯è§£é‡Š

## ä¸€ã€ Container å®¹å™¨
> å®¹å™¨æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è¿›ç¨‹ï¼Œé€šè¿‡ Namespace å®ç°èµ„æºï¼ˆç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿç­‰ï¼‰éš”ç¦»ï¼Œé€šè¿‡ Cgroups å®ç°èµ„æºï¼ˆCPUã€å†…å­˜ï¼‰é™åˆ¶ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨èµ·æ¥å°±æ„Ÿè§‰åƒåœ¨æ“ä½œè™šæ‹Ÿæœºä¸€æ ·ï¼Œä½†å…¶å’Œè™šæ‹Ÿæœºæœ‰æœ¬è´¨ä¸Šçš„åŒºåˆ«ï¼Œé‚£å°±æ˜¯å®¹å™¨å’Œå®¿ä¸»æœºæ˜¯å…±äº«åŒä¸€ä¸ªå†…æ ¸çš„ã€‚ä¸ºäº†å°†æˆ‘ä»¬çš„åº”ç”¨è¿›ç¨‹è¿è¡Œåœ¨å®¹å™¨ä¸­ï¼Œå½“ç„¶å°±éœ€è¦æœ‰ä¸€äº›æ–¹ä¾¿çš„æ¥å£æˆ–è€…å‘½ä»¤å»è°ƒç”¨ Linux çš„ç³»ç»ŸåŠŸèƒ½æ¥å®ç°ï¼Œè€Œå®¹å™¨è¿è¡Œæ—¶å°±æ˜¯ç”¨æ¥è¿è¡Œå’Œç®¡ç†å®¹å™¨è¿›ç¨‹ã€é•œåƒçš„å·¥å…·

## äºŒã€ OCI (Open Container Initiative) å¼€æ”¾å®¹å™¨åè®®
> (OCI) æ˜¯ç”± Docker äº 2015 å¹´å‘èµ·ï¼Œå¹¶åœ¨ Linux Foundationï¼ˆLinux åŸºé‡‘ä¼šï¼‰ä¸‹ç®¡ç†çš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œæ—¨åœ¨å®šä¹‰å¹¶ç»´æŠ¤å®¹å™¨é•œåƒå’Œè¿è¡Œæ—¶çš„å¼€æ”¾æ ‡å‡†ã€‚OCI è§„èŒƒçš„ç›®æ ‡æ˜¯ç¡®ä¿ä¸åŒå®¹å™¨å¼•æ“ã€é•œåƒå’Œè¿è¡Œæ—¶ä¹‹é—´çš„å…¼å®¹æ€§å’Œäº’æ“ä½œæ€§

OCI å®šä¹‰äº†ä»¥ä¸‹ä¸‰å¤§æ ¸å¿ƒè§„èŒƒï¼š
- 1. `OCI Runtime Specification`ï¼ˆOCI è¿è¡Œæ—¶è§„èŒƒï¼‰
  > å®šä¹‰äº†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬å®¹å™¨çš„åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢ã€é”€æ¯ç­‰

    - è§„èŒƒå®¹å™¨è¿è¡Œæ—¶çš„æ¥å£ï¼Œç¡®ä¿è¿è¡Œæ—¶å¦‚ä½•ä»¥ä¸€è‡´çš„æ–¹å¼æ‰§è¡Œå®¹å™¨
    - è¯¥è§„èŒƒè¢«å¹¿æ³›é‡‡ç”¨ï¼Œ`runc` å°±æ˜¯ `OCI` è¿è¡Œæ—¶è§„èŒƒçš„å‚è€ƒå®ç°
    - æ ¸å¿ƒæ§åˆ¶å®¹å™¨çš„ä½çº§ç»†èŠ‚ï¼Œå¦‚ï¼š
      - å®¹å™¨çš„è¿›ç¨‹ç®¡ç†
      - æŒ‚è½½ç‚¹ã€`Cgroups`ã€`Namespace` é…ç½®
      - å®¹å™¨çš„ `rootfs` é…ç½®

- 2. `OCI Image Specification`ï¼ˆOCI é•œåƒè§„èŒƒï¼‰
  > å®šä¹‰äº†å®¹å™¨é•œåƒçš„æ ¼å¼åŠå…¶å…ƒæ•°æ®ã€‚

    - è¯¥è§„èŒƒç¡®ä¿å®¹å™¨é•œåƒåœ¨ä¸åŒçš„å®¹å™¨è¿è¡Œæ—¶ï¼ˆå¦‚ `Docker`ã€`containerd`ã€`CRI-O` ç­‰ï¼‰ä¸­å‡èƒ½æ— ç¼å…¼å®¹ã€‚
    - é•œåƒé‡‡ç”¨ å¤šå±‚ï¼ˆ`Layered`ï¼‰ ç»“æ„ï¼Œå…è®¸å¢é‡æ›´æ–°ï¼Œæé«˜å­˜å‚¨å’Œä¼ è¾“æ•ˆç‡
    - å®šä¹‰äº†é•œåƒçš„å†…å®¹æ¸…å•ï¼ˆ`Manifest`ï¼‰ã€é…ç½®ï¼ˆ`Config`ï¼‰åŠé•œåƒå±‚ï¼ˆ`Layers`ï¼‰ç­‰

- 3. `OCI Distribution Specification`ï¼ˆOCI åˆ†å‘è§„èŒƒï¼‰
  > å®šä¹‰äº†å¦‚ä½•é€šè¿‡ HTTP API æ¥åˆ†å‘å®¹å™¨é•œåƒï¼ˆé•œåƒä»“åº“è§„èŒƒï¼‰

    - è¯¥è§„èŒƒç¡®ä¿é•œåƒå¯ä»¥åœ¨ä¸åŒçš„é•œåƒä»“åº“ï¼ˆå¦‚ `Docker Hub`ã€`Harbor`ã€`Quay.io` ç­‰ï¼‰ä¸­å®‰å…¨ä¼ è¾“å’Œåˆ†å‘ã€‚
    - åŸºäº `RESTful API` è®¾è®¡ï¼Œæ”¯æŒå¤šç§èº«ä»½éªŒè¯å’Œå®‰å…¨æœºåˆ¶
    - è§£å†³äº†é•œåƒæ‹‰å–ã€æ¨é€åŠå­˜å‚¨çš„å…¼å®¹æ€§é—®é¢˜

OCI çš„ç”Ÿæ€ç³»ç»Ÿ

  - `RUNC`ï¼ˆOCI è¿è¡Œæ—¶çš„å‚è€ƒå®ç°ï¼‰
  - `Containerd`ï¼ˆDocker çš„æ ¸å¿ƒå®¹å™¨è¿è¡Œæ—¶ï¼Œå®Œå…¨å…¼å®¹ OCIï¼‰
  - `CRI-O`ï¼ˆKubernetes çš„è½»é‡çº§å®¹å™¨è¿è¡Œæ—¶ï¼‰
  - `Podman`ï¼ˆæ— å®ˆæŠ¤è¿›ç¨‹çš„å®¹å™¨å¼•æ“ï¼Œå…¼å®¹ OCIï¼‰
  - `Docker`ï¼ˆå·²å°† OCI è§„èŒƒæ•´åˆè‡³å…¶å¼•æ“ï¼‰

æ€»ç»“:
> Open Container Initiative (OCI) é€šè¿‡å®šä¹‰å¼€æ”¾æ ‡å‡†ï¼Œç»Ÿä¸€äº†å®¹å™¨é•œåƒã€è¿è¡Œæ—¶å’Œåˆ†å‘æ–¹å¼ï¼Œæ¨åŠ¨äº†å®¹å™¨æŠ€æœ¯çš„ç”Ÿæ€ç¹è£ã€‚å®ƒçš„æ ¸å¿ƒç›®æ ‡æ˜¯è®©å®¹å™¨ç¯å¢ƒæ›´åŠ ä¾¿æºã€å…¼å®¹å’Œå®‰å…¨


## CRI (Container Runtime Interface) å®¹å™¨è¿è¡Œæ—¶æ¥å£
> Kubernetes å®šä¹‰çš„ä¸€å¥—æ ‡å‡†åŒ–æ¥å£ï¼Œæ—¨åœ¨å°† Kubernetes (K8s) ä¸å„ç§å®¹å™¨è¿è¡Œæ—¶ï¼ˆå¦‚ Dockerã€containerdã€CRI-O ç­‰ï¼‰è§£è€¦ã€‚é€šè¿‡ CRIï¼Œkubeletå¯ä»¥ä½¿ç”¨ä¸åŒçš„å®¹å™¨è¿è¡Œæ—¶ï¼Œè€Œæ— éœ€æ›´æ”¹è‡ªèº«çš„ä»£ç é€»è¾‘ï¼Œä»è€Œæå‡äº† Kubernetes çš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚

  ![å›¾](/images/111.container.md.01.png)



## CRI-O (Container Runtime Interface - Open Container Initiative) 

> CRI-O æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer Runtimeï¼‰ï¼Œä¸“ä¸º Kubernetes è®¾è®¡ï¼Œå®Œå…¨éµå¾ª Kubernetes çš„ CRIï¼ˆContainer Runtime Interfaceï¼‰ æ¥å£æ ‡å‡†

`CRI-O`ã€ `Docker`ã€ `containerd` ä¸‰è€…å¯¹æ¯”

|ç‰¹ç‚¹|`CRI-O`| `Docker`| `containerd`|
|--|--|--|--|
|å…¼å®¹ `Kubernetes`|âœ… å®Œå…¨å…¼å®¹	|âŒ éœ€é¢å¤–é…ç½®|	âœ… å®Œå…¨å…¼å®¹|
|éµå¾ª `OCI` æ ‡å‡†|	âœ… æ˜¯|	âœ… æ˜¯|	âœ… æ˜¯|
|æ˜¯å¦è½»é‡|	âœ… æç®€è®¾è®¡|	âŒ åŠŸèƒ½å¤æ‚|	âœ… è½»é‡åŒ–|
|é•œåƒç®¡ç†|	âœ… ä½¿ç”¨ `skopeo`|	âœ… åŸç”Ÿæ”¯æŒ|	âœ… ä½¿ç”¨ `ctr`|
|å®ˆæŠ¤è¿›ç¨‹|	âŒ æ— å®ˆæŠ¤è¿›ç¨‹|	âœ… éœ€è¦ `Docker Daemon`|	âœ… éœ€è¦å®ˆæŠ¤è¿›ç¨‹|
|å¯åŠ¨é€Ÿåº¦|	âš¡ å¿«é€Ÿ|	ğŸš¶â€â™‚ï¸ è¾ƒæ…¢|	âš¡ å¿«é€Ÿ|
|å­˜å‚¨é©±åŠ¨|	æ”¯æŒå¤šç§å­˜å‚¨åç«¯|	ä½¿ç”¨ `Docker` å†…ç½®æœºåˆ¶|	ä½¿ç”¨ `snapshotter`|
## CRI-Dockerd å’Œ CRI-ContainerD


|ç‰¹ç‚¹ |`cri-docker` |`cri-containerd`|
|--|--|--|
|å®šä¹‰| Docker æä¾›çš„ CRI å®ç°ï¼Œä½œä¸º Docker Engine çš„æ¡¥æ¢ä»¥å…¼å®¹ Kubernetes| containerd æä¾›çš„åŸç”Ÿ CRI å®ç°ï¼Œä¸“ä¸º Kubernetes è®¾è®¡|
|æ¶æ„| `kubelet â†’ cri-dockerd â†’ Docker Engine â†’ containerd â†’ runc`|`kubelet â†’ containerd â†’ runc`|
|å¤æ‚åº¦|ç”±äºå¼•å…¥ Docker Daemonï¼Œæ¶æ„æ›´å¤æ‚|è½»é‡åŒ–è®¾è®¡ï¼Œç›´æ¥å¯¹æ¥ Kubernetesï¼Œæ¶æ„æ›´ç®€æ´|

cat <<EOF | tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.29/rpm/
enabled=1
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.28/rpm/repodata/repomd.xml.key
EOF
setenforce 0
yum install -y kubelet kubeadm kubectl
systemctl enable kubelet && systemctl start kubelet


kubeadm init --apiserver-advertise-address=192.168.100.115 --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v1.29.15 --service-cidr=10.10.0.0/12 --pod-network-cidr=10.244.0.0/16 --cri-socket unix:///var/run/cri-dockerd.sock


kubeadm join 192.168.100.115:6443 --token 5p3w36.aoah5z734lw70nji \
        --discovery-token-ca-cert-hash sha256:fda08928eeeb8cdb424462c29999643a5561bf9ffdf31dabfdc5ca562cce5953 --cri-socket unix:///var/run/cri-dockerd.sock